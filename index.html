<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Mathematical Calculator with Ten Variables</title>

    <link rel="manifest" href="manifest.json">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5712588524765113" crossorigin="anonymous"></script>
    
    <style>
        /* [ALL YOUR EXISTING CSS STYLES - KEEP THEM EXACTLY AS THEY ARE] */
        /* Copy all the CSS from your current working file here */
        /* I'm including a condensed version for brevity */
        * { box-sizing: border-box; }
        body { font-family: Arial; margin: 5px; padding: 5px; font-size: 8px; max-width: 100%; overflow-x: hidden; background-color: #f8f9fa; }
        .main-container { max-width: 380px; margin: 0 auto; padding: 5px; }
        .download-section { background-color: #e3f2fd; border-radius: 6px; padding: 6px; margin-bottom: 8px; border: 1px solid #bbdefb; }
        .title-section { text-align: center; margin-bottom: 8px; padding: 5px; background-color: white; border-radius: 6px; border: 1px solid #e0e0e0; }
        .title-img { max-width: 100%; height: auto; margin-bottom: 3px; }
        .subtitle { font-size: 9px; color: #666; line-height: 1.2; }
        .calculation-group { margin-bottom: 6px; padding: 6px; background-color: white; border-radius: 5px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .calculator-header { display: flex; align-items: center; margin-bottom: 4px; flex-wrap: wrap; gap: 3px; }
        .calculator-label { font-size: 9px; font-weight: bold; color: #000; min-width: 45px; }
        .variable-name-input { width: 40px !important; height: 20px; font-size: 8px; padding: 1px 3px; border: 1px solid #ccc; border-radius: 2px; }
        .notes-input { width: 75px !important; height: 20px; font-size: 8px; padding: 1px 3px; border: 1px solid #ccc; border-radius: 2px; }
        .expression-input { width: 100% !important; height: 22px; font-size: 9px; padding: 2px 5px; margin: 4px 0; border: 1px solid #ccc; border-radius: 3px; }
        .result-container { display: flex; align-items: center; margin-top: 4px; background-color: #fff5f5; padding: 3px 5px; border-radius: 3px; border: 1px solid #ffcdd2; }
        .result-label { font-size: 9px; font-weight: bold; color: #FF0000; min-width: 40px; }
        .result-output { flex: 1; height: 20px; font-size: 10px; padding: 2px 5px; border: none; background: transparent; color: #FF0000; font-weight: bold; display: flex; align-items: center; }
        .save-btn { background-color: #4CAF50; color: white; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 8px; height: 20px; min-width: 35px; }
        .save-expr-btn { background-color: #2196F3; color: white; border: none; padding: 2px 6px; border-radius: 2px; cursor: pointer; font-size: 8px; height: 20px; margin-right: 5px; }
        .saved-indicator { color: #4CAF50; font-size: 8px; margin-left: 2px; display: none; }
        .syntax-help { font-size: 7px; color: #808080; margin: 3px 0; line-height: 1.1; background-color: #f5f5f5; padding: 3px; border-radius: 2px; }
        .variables-container { margin: 8px 0; background-color: white; padding: 6px; border-radius: 5px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .variables-title { font-size: 9px; font-weight: bold; margin-bottom: 5px; color: #000; }
        .variables-subtitle { font-size: 8px; color: #666; margin-bottom: 5px; line-height: 1.2; }
        .variable-row { display: flex; align-items: center; margin-bottom: 3px; flex-wrap: nowrap; gap: 2px; }
        .var-name-input { width: 35px !important; height: 18px; font-size: 8px; padding: 1px 3px; border: 1px solid #ccc; border-radius: 2px; }
        .var-colon { font-size: 9px; margin: 0 1px; color: #666; min-width: 8px; text-align: center; }
        .var-value-input { width: 50px !important; height: 18px; font-size: 8px; padding: 1px 3px; border: 1px solid #ccc; border-radius: 2px; }
        .var-unit-input { width: 45px !important; height: 18px; font-size: 8px; padding: 1px 3px; border: 1px solid #ccc; border-radius: 2px; }
        .compact-save-btn { background-color: #4CAF50; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 7px; height: 18px; min-width: 25px; }
        .unit-converter-btn { background-color: #9c27b0; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 9px; margin: 5px 0; width: 100%; }
        #addCalculatorBtn { margin: 6px 0; padding: 6px 10px; background-color: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px; width: 100%; }
        .notes-container { margin: 8px 0; padding: 6px; background-color: white; border-radius: 5px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .notes-label { font-size: 9px; font-weight: bold; margin-bottom: 4px; display: block; color: #000; }
        .notes-field { width: 100%; height: 60px; font-size: 9px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; resize: vertical; overflow: auto; background-color: #fffff0; }
        .download-btn { background-color: #2196F3; color: white; border: none; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 9px; width: 100%; }
        #downloadStatus { display: block; font-size: 8px; color: #666; margin-top: 3px; text-align: center; }
        #installApp { background-color: #673ab7; color: white; border: none; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 9px; width: 100%; margin: 3px 0; display: none; }
        .help-text { font-size: 8px; color: #666; margin: 3px 0; line-height: 1.2; text-align: center; }
        #unitConverterModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; padding: 10px; }
        #unitConverterContent { background-color: #FFFFFF; margin: 0 auto; padding: 10px; border-radius: 8px; width: 100%; max-width: 360px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        #closeUnitConverter { position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        @media (max-width: 360px) { .main-container { max-width: 340px; padding: 3px; } .variable-name-input { width: 38px !important; } .notes-input { width: 70px !important; } .var-name-input { width: 32px !important; } .var-value-input { width: 45px !important; } .var-unit-input { width: 40px !important; } }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Download Section -->
        <div class="download-section">
            <button class="download-btn" onclick="downloadAsHTML()">‚¨áÔ∏è Download Calculator as HTML</button>
            <span id="downloadStatus"></span>
            <button id="installApp">üì± Install App</button>
        </div>
        
        <!-- Title Section -->
        <div class="title-section">
            <img src="title.jpg" alt="Math Tool Box" class="title-img">
            <div class="subtitle">
                <i>for scientific, engineering, and day-to-day calculations</i> 
                <span style="font-size: 10px;">&#9881;&#9787;&#9786;</span>
            </div>
        </div>
        
        <div class="help-text">
            Example equations: <i><b>PV = nRT</b></i> (ideal gas law), 
            <i><b>Net present value = Rt/(1+i)^t</b></i>
        </div>
       
        <!-- Container for all calculators -->
        <div id="calculatorsContainer">
            <!-- First Calculation Group -->
            <div class="calculation-group" id="calculator_1">
                <div class="calculator-header">
                    <span class="calculator-label">Calc:</span>
                    <input type="text" class="variable-name-input" id="resultField1" placeholder="var">
                    <button class="save-btn" data-field="resultField1">üíæ</button>
                    <span class="saved-indicator" id="saved_resultField1">‚úì</span>
                    <input type="text" class="notes-input" placeholder="Notes" id="notesField1">
                    <button class="save-btn" data-field="notesField1">üíæ</button>
                    <span class="saved-indicator" id="saved_notesField1">‚úì</span>
                </div>
                
                <input type="text" class="expression-input" id="inputField1" placeholder="e.g., n*R*T/V">
                
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <button class="save-expr-btn" data-field="inputField1">üíæ Save</button>
                    <span class="saved-indicator" id="saved_inputField1">‚úì Saved</span>
                </div>
                
                <div class="syntax-help">
                    Syntax: <b>logx(y)</b>, <b>pi</b>=3.14159, <b>e</b>=2.718, 
                    <b>sin-1(x)</b>, angles in degrees
                </div>
                
                <div class="result-container">
                    <span class="result-label">Result:</span>
                    <div class="result-output" id="outputField1">0</div>
                </div>
            </div>

            <!-- Second Calculation Group -->
            <div class="calculation-group" id="calculator_2">
                <div class="calculator-header">
                    <span class="calculator-label">Calc:</span>
                    <input type="text" class="variable-name-input" id="resultField2" placeholder="var">
                    <button class="save-btn" data-field="resultField2">üíæ</button>
                    <span class="saved-indicator" id="saved_resultField2">‚úì</span>
                    <input type="text" class="notes-input" placeholder="Notes" id="notesField2">
                    <button class="save-btn" data-field="notesField2">üíæ</button>
                    <span class="saved-indicator" id="saved_notesField2">‚úì</span>
                </div>
                
                <input type="text" class="expression-input" id="inputField2" placeholder="e.g., x! + y * sin(z) + log2(a)">
                
                <div style="display: flex; align-items: center; margin: 3px 0;">
                    <button class="save-expr-btn" data-field="inputField2">üíæ Save</button>
                    <span class="saved-indicator" id="saved_inputField2">‚úì Saved</span>
                </div>
                
                <div class="result-container">
                    <span class="result-label">Result:</span>
                    <div class="result-output" id="outputField2">0</div>
                </div>
            </div>
        </div>

        <!-- Add Calculator Button -->
        <button id="addCalculatorBtn">+ Add More Calculators</button>
        
        <div class="help-text">
            Equations: chemistry, physics, statistics, engineering, economics.
        </div>

        <!-- Variables Section -->
        <div class="variables-container">
            <div class="variables-title">
                Variables (with consistent units)
            </div>
            
            <button onclick="showUnitConverter()" class="unit-converter-btn">
                üìê Open Unit Converter
            </button>
            
            <!-- Variable Inputs - 10 rows -->
            <div class="variable-row">
                <input type="text" class="var-name-input" id="variableName1" placeholder="V">
                <button class="compact-save-btn" data-field="variableName1">üíæ</button>
                <span class="saved-indicator" id="saved_variableName1">‚úì</span>
                <span class="var-colon">:</span>
                <input type="text" class="var-value-input" id="variableValue1" placeholder="10">
                <button class="compact-save-btn" data-field="variableValue1">üíæ</button>
                <span class="saved-indicator" id="saved_variableValue1">‚úì</span>
                <input type="text" class="var-unit-input" id="unit1" placeholder="m¬≥">
                <button class="compact-save-btn" data-field="unit1">üíæ</button>
                <span class="saved-indicator" id="saved_unit1">‚úì</span>
            </div>
            
            <!-- Repeat for variable rows 2-10 -->
            <div class="variable-row">
                <input type="text" class="var-name-input" id="variableName2" placeholder="n">
                <button class="compact-save-btn" data-field="variableName2">üíæ</button>
                <span class="saved-indicator" id="saved_variableName2">‚úì</span>
                <span class="var-colon">:</span>
                <input type="text" class="var-value-input" id="variableValue2" placeholder="2">
                <button class="compact-save-btn" data-field="variableValue2">üíæ</button>
                <span class="saved-indicator" id="saved_variableValue2">‚úì</span>
                <input type="text" class="var-unit-input" id="unit2" placeholder="mol">
                <button class="compact-save-btn" data-field="unit2">üíæ</button>
                <span class="saved-indicator" id="saved_unit2">‚úì</span>
            </div>
            
            <!-- Add rows 3-10 similarly... -->
            <!-- For brevity, I'll show pattern for remaining rows -->
            <div class="variable-row" id="varRow3"><input type="text" class="var-name-input" id="variableName3" placeholder="R"><button class="compact-save-btn" data-field="variableName3">üíæ</button><span class="saved-indicator" id="saved_variableName3">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue3" placeholder="8.314"><button class="compact-save-btn" data-field="variableValue3">üíæ</button><span class="saved-indicator" id="saved_variableValue3">‚úì</span><input type="text" class="var-unit-input" id="unit3" placeholder="J/mol¬∑K"><button class="compact-save-btn" data-field="unit3">üíæ</button><span class="saved-indicator" id="saved_unit3">‚úì</span></div>
            <div class="variable-row" id="varRow4"><input type="text" class="var-name-input" id="variableName4" placeholder="T"><button class="compact-save-btn" data-field="variableName4">üíæ</button><span class="saved-indicator" id="saved_variableName4">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue4" placeholder="300"><button class="compact-save-btn" data-field="variableValue4">üíæ</button><span class="saved-indicator" id="saved_variableValue4">‚úì</span><input type="text" class="var-unit-input" id="unit4" placeholder="K"><button class="compact-save-btn" data-field="unit4">üíæ</button><span class="saved-indicator" id="saved_unit4">‚úì</span></div>
            <div class="variable-row" id="varRow5"><input type="text" class="var-name-input" id="variableName5" placeholder=""><button class="compact-save-btn" data-field="variableName5">üíæ</button><span class="saved-indicator" id="saved_variableName5">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue5" placeholder=""><button class="compact-save-btn" data-field="variableValue5">üíæ</button><span class="saved-indicator" id="saved_variableValue5">‚úì</span><input type="text" class="var-unit-input" id="unit5" placeholder=""><button class="compact-save-btn" data-field="unit5">üíæ</button><span class="saved-indicator" id="saved_unit5">‚úì</span></div>
            <div class="variable-row" id="varRow6"><input type="text" class="var-name-input" id="variableName6" placeholder=""><button class="compact-save-btn" data-field="variableName6">üíæ</button><span class="saved-indicator" id="saved_variableName6">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue6" placeholder=""><button class="compact-save-btn" data-field="variableValue6">üíæ</button><span class="saved-indicator" id="saved_variableValue6">‚úì</span><input type="text" class="var-unit-input" id="unit6" placeholder=""><button class="compact-save-btn" data-field="unit6">üíæ</button><span class="saved-indicator" id="saved_unit6">‚úì</span></div>
            <div class="variable-row" id="varRow7"><input type="text" class="var-name-input" id="variableName7" placeholder=""><button class="compact-save-btn" data-field="variableName7">üíæ</button><span class="saved-indicator" id="saved_variableName7">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue7" placeholder=""><button class="compact-save-btn" data-field="variableValue7">üíæ</button><span class="saved-indicator" id="saved_variableValue7">‚úì</span><input type="text" class="var-unit-input" id="unit7" placeholder=""><button class="compact-save-btn" data-field="unit7">üíæ</button><span class="saved-indicator" id="saved_unit7">‚úì</span></div>
            <div class="variable-row" id="varRow8"><input type="text" class="var-name-input" id="variableName8" placeholder=""><button class="compact-save-btn" data-field="variableName8">üíæ</button><span class="saved-indicator" id="saved_variableName8">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue8" placeholder=""><button class="compact-save-btn" data-field="variableValue8">üíæ</button><span class="saved-indicator" id="saved_variableValue8">‚úì</span><input type="text" class="var-unit-input" id="unit8" placeholder=""><button class="compact-save-btn" data-field="unit8">üíæ</button><span class="saved-indicator" id="saved_unit8">‚úì</span></div>
            <div class="variable-row" id="varRow9"><input type="text" class="var-name-input" id="variableName9" placeholder=""><button class="compact-save-btn" data-field="variableName9">üíæ</button><span class="saved-indicator" id="saved_variableName9">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue9" placeholder=""><button class="compact-save-btn" data-field="variableValue9">üíæ</button><span class="saved-indicator" id="saved_variableValue9">‚úì</span><input type="text" class="var-unit-input" id="unit9" placeholder=""><button class="compact-save-btn" data-field="unit9">üíæ</button><span class="saved-indicator" id="saved_unit9">‚úì</span></div>
            <div class="variable-row" id="varRow10"><input type="text" class="var-name-input" id="variableName10" placeholder=""><button class="compact-save-btn" data-field="variableName10">üíæ</button><span class="saved-indicator" id="saved_variableName10">‚úì</span><span class="var-colon">:</span><input type="text" class="var-value-input" id="variableValue10" placeholder=""><button class="compact-save-btn" data-field="variableValue10">üíæ</button><span class="saved-indicator" id="saved_variableValue10">‚úì</span><input type="text" class="var-unit-input" id="unit10" placeholder=""><button class="compact-save-btn" data-field="unit10">üíæ</button><span class="saved-indicator" id="saved_unit10">‚úì</span></div>
        </div>

        <!-- Notes Section -->
        <div class="notes-container">
            <span class="notes-label">Notes:</span>
            <div id="notesField" class="notes-field" contenteditable="true" placeholder="Write your notes here..."></div>
            <div style="margin-top: 4px;">
                <button class="save-btn" onclick="saveNotes()">üíæ Save Notes</button>
                <span class="saved-indicator" id="saved_notesField">‚úì Saved</span>
            </div>
            <div class="help-text" style="margin-top: 4px;">
                Advanced scientific calculator, All purpose, Excel like
            </div>
        </div>

        <!-- Unit Converter Modal (simplified for example) -->
        <div id="unitConverterModal">
            <div id="unitConverterContent">
                <button id="closeUnitConverter" onclick="closeUnitConverter()">√ó</button>
                <div style="font-size: 11px; font-weight: bold; margin-bottom: 8px; color: #000;">
                    Universal Unit Converter
                </div>
                <!-- Converter content... -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SOLUTION A: CLEAN RECREATION IMPLEMENTATION
        // ============================================
        
        // Global state
        let calculatorCount = 2; // Start with 2 calculators
        let savedInputs = {}; // Stores all user data
        let variables = {}; // For calculations
        
        // ============================================
        // 1. CORE FUNCTIONS (Save, Create, Calculate)
        // ============================================
        
        // Save any input field
        function saveInput(fieldId) {
            const element = document.getElementById(fieldId);
            if (element) {
                savedInputs[fieldId] = element.value;
                
                const indicator = document.getElementById('saved_' + fieldId);
                if (indicator) {
                    indicator.style.display = 'inline';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }
        }
        
        // Save notes
        function saveNotes() {
            const notesField = document.getElementById('notesField');
            if (notesField) {
                savedInputs['notesField'] = notesField.innerHTML;
                
                const indicator = document.getElementById('saved_notesField');
                if (indicator) {
                    indicator.style.display = 'inline';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }
        }
        
        // Create a new calculator
        function createCalculator(calculatorId) {
            const calculatorHTML = `
                <div class="calculation-group" id="calculator_${calculatorId}">
                    <div class="calculator-header">
                        <span class="calculator-label">Calc:</span>
                        <input type="text" class="variable-name-input" id="resultField${calculatorId}" placeholder="var">
                        <button class="save-btn" data-field="resultField${calculatorId}">üíæ</button>
                        <span class="saved-indicator" id="saved_resultField${calculatorId}">‚úì</span>
                        <input type="text" class="notes-input" placeholder="Notes" id="notesField${calculatorId}">
                        <button class="save-btn" data-field="notesField${calculatorId}">üíæ</button>
                        <span class="saved-indicator" id="saved_notesField${calculatorId}">‚úì</span>
                    </div>
                    
                    <input type="text" class="expression-input" id="inputField${calculatorId}" placeholder="Enter expression">
                    
                    <div style="display: flex; align-items: center; margin: 3px 0;">
                        <button class="save-expr-btn" data-field="inputField${calculatorId}">üíæ Save</button>
                        <span class="saved-indicator" id="saved_inputField${calculatorId}">‚úì Saved</span>
                    </div>
                    
                    <div class="result-container">
                        <span class="result-label">Result:</span>
                        <div class="result-output" id="outputField${calculatorId}">0</div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('calculatorsContainer');
            const newCalculator = document.createElement('div');
            newCalculator.innerHTML = calculatorHTML;
            container.appendChild(newCalculator.firstElementChild);
            
            setupCalculatorEvents(calculatorId);
        }
        
        // Setup event listeners for a calculator
        function setupCalculatorEvents(calculatorId) {
            const inputField = document.getElementById(`inputField${calculatorId}`);
            const outputField = document.getElementById(`outputField${calculatorId}`);
            const resultField = document.getElementById(`resultField${calculatorId}`);
            
            if (inputField && outputField && resultField) {
                inputField.addEventListener('input', function() {
                    evaluateExpression(inputField.value, outputField, resultField);
                });
                
                resultField.addEventListener('input', function() {
                    updateVariables();
                    evaluateAllCalculators();
                });
            }
        }
        
        // Add calculator button
        document.getElementById('addCalculatorBtn').addEventListener('click', function() {
            calculatorCount++;
            createCalculator(calculatorCount);
        });
        
        // ============================================
        // 2. DOWNLOAD FUNCTIONALITY (SOLUTION A)
        // ============================================
        
        function downloadAsHTML() {
            // Update all calculations before saving
            evaluateAllCalculators();
            
            // Collect all application data
            const appData = {
                calculatorCount: calculatorCount,
                timestamp: new Date().toISOString(),
                
                calculators: [],
                variables: [],
                notes: document.getElementById('notesField').innerHTML
            };
            
            // Save calculator data
            for (let i = 1; i <= calculatorCount; i++) {
                const inputField = document.getElementById(`inputField${i}`);
                const resultField = document.getElementById(`resultField${i}`);
                const notesField = document.getElementById(`notesField${i}`);
                const outputField = document.getElementById(`outputField${i}`);
                
                if (inputField && resultField) {
                    appData.calculators.push({
                        id: i,
                        expression: inputField.value,
                        resultName: resultField.value,
                        notes: notesField ? notesField.value : '',
                        resultValue: outputField ? outputField.textContent : '0'
                    });
                }
            }
            
            // Save variable data
            for (let i = 1; i <= 10; i++) {
                const nameField = document.getElementById(`variableName${i}`);
                const valueField = document.getElementById(`variableValue${i}`);
                const unitField = document.getElementById(`unit${i}`);
                
                if (nameField && valueField && unitField) {
                    appData.variables.push({
                        id: i,
                        name: nameField.value,
                        value: valueField.value,
                        unit: unitField.value
                    });
                }
            }
            
            // Create the HTML file content
            const htmlContent = createDownloadableHTML(appData);
            
            // Download the file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            a.download = `MathCalculator-${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show download status
            const status = document.getElementById('downloadStatus');
            if (status) {
                status.textContent = `‚úì Downloaded with ${calculatorCount} calculators!`;
                setTimeout(() => {
                    status.textContent = '';
                }, 3000);
            }
        }
        
        // Create the downloadable HTML file
        function createDownloadableHTML(appData) {
            // Get current page's HTML structure
            const currentHTML = document.documentElement.outerHTML;
            
            // Extract the main container HTML (everything inside body)
            const bodyStart = currentHTML.indexOf('<body>');
            const bodyEnd = currentHTML.indexOf('</body>');
            let bodyContent = currentHTML.substring(bodyStart + 6, bodyEnd);
            
            // Remove the download section from the downloaded version
            bodyContent = bodyContent.replace(/<div class="download-section">[\s\S]*?<\/div>/, 
                '<div class="download-section" style="display: none;">' +
                '<span id="downloadStatus">‚úì Calculator downloaded and ready for offline use</span>' +
                '</div>');
            
            // Create the complete HTML file with initialization script
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Mathematical Calculator</title>
    <style>
        ${getAllCSS()}
    </style>
</head>
<body>
    ${bodyContent}
    
    <script>
        // ============================================
        // INITIALIZATION FOR DOWNLOADED FILE
        // ============================================
        
        // Application data from when it was saved
        const savedAppData = ${JSON.stringify(appData, null, 4)};
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Restoring calculator state...');
            
            // 1. Recreate additional calculators if needed
            if (savedAppData.calculatorCount > 2) {
                for (let i = 3; i <= savedAppData.calculatorCount; i++) {
                    createCalculator(i);
                }
            }
            
            // 2. Wait a moment for DOM to be ready, then restore data
            setTimeout(function() {
                // Restore calculator data
                savedAppData.calculators.forEach(calc => {
                    const inputField = document.getElementById('inputField' + calc.id);
                    const resultField = document.getElementById('resultField' + calc.id);
                    const notesField = document.getElementById('notesField' + calc.id);
                    const outputField = document.getElementById('outputField' + calc.id);
                    
                    if (inputField) inputField.value = calc.expression || '';
                    if (resultField) resultField.value = calc.resultName || '';
                    if (notesField) notesField.value = calc.notes || '';
                    if (outputField) outputField.textContent = calc.resultValue || '0';
                });
                
                // Restore variable data
                savedAppData.variables.forEach(variable => {
                    const nameField = document.getElementById('variableName' + variable.id);
                    const valueField = document.getElementById('variableValue' + variable.id);
                    const unitField = document.getElementById('unit' + variable.id);
                    
                    if (nameField) nameField.value = variable.name || '';
                    if (valueField) valueField.value = variable.value || '';
                    if (unitField) unitField.value = variable.unit || '';
                });
                
                // Restore notes
                const notesField = document.getElementById('notesField');
                if (notesField && savedAppData.notes) {
                    notesField.innerHTML = savedAppData.notes;
                }
                
                // Setup all event listeners
                setupAllEventListeners();
                
                // Perform initial calculations
                setTimeout(function() {
                    updateVariables();
                    evaluateAllCalculators();
                    console.log('Calculator restored successfully with', 
                        savedAppData.calculatorCount, 'calculators');
                }, 200);
                
            }, 100);
        });
        
        // Include all the calculator functions
        ${getAllEssentialFunctions()}
    <\/script>
</body>
</html>`;
        }
        
        // Helper to get all CSS
        function getAllCSS() {
            // Extract all CSS from style tags
            const styles = Array.from(document.querySelectorAll('style'))
                .map(style => style.innerHTML)
                .join('\\n');
            return styles;
        }
        
        // Helper to get essential functions as string
        function getAllEssentialFunctions() {
            return `
            // Core calculator functions
            let calculatorCount = 2;
            let savedInputs = {};
            let variables = {};
            
            function saveInput(fieldId) {
                const element = document.getElementById(fieldId);
                if (element) {
                    savedInputs[fieldId] = element.value;
                    const indicator = document.getElementById('saved_' + fieldId);
                    if (indicator) {
                        indicator.style.display = 'inline';
                        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                    }
                }
            }
            
            function saveNotes() {
                const notesField = document.getElementById('notesField');
                if (notesField) {
                    savedInputs['notesField'] = notesField.innerHTML;
                    const indicator = document.getElementById('saved_notesField');
                    if (indicator) {
                        indicator.style.display = 'inline';
                        setTimeout(() => { indicator.style.display = 'none'; }, 2000);
                    }
                }
            }
            
            function createCalculator(calculatorId) {
                const calculatorHTML = \`
                    <div class="calculation-group" id="calculator_\${calculatorId}">
                        <div class="calculator-header">
                            <span class="calculator-label">Calc:</span>
                            <input type="text" class="variable-name-input" id="resultField\${calculatorId}" placeholder="var">
                            <button class="save-btn" data-field="resultField\${calculatorId}">üíæ</button>
                            <span class="saved-indicator" id="saved_resultField\${calculatorId}">‚úì</span>
                            <input type="text" class="notes-input" placeholder="Notes" id="notesField\${calculatorId}">
                            <button class="save-btn" data-field="notesField\${calculatorId}">üíæ</button>
                            <span class="saved-indicator" id="saved_notesField\${calculatorId}">‚úì</span>
                        </div>
                        
                        <input type="text" class="expression-input" id="inputField\${calculatorId}" placeholder="Enter expression">
                        
                        <div style="display: flex; align-items: center; margin: 3px 0;">
                            <button class="save-expr-btn" data-field="inputField\${calculatorId}">üíæ Save</button>
                            <span class="saved-indicator" id="saved_inputField\${calculatorId}">‚úì Saved</span>
                        </div>
                        
                        <div class="result-container">
                            <span class="result-label">Result:</span>
                            <div class="result-output" id="outputField\${calculatorId}">0</div>
                        </div>
                    </div>
                \`;
                
                const container = document.getElementById('calculatorsContainer');
                const newCalculator = document.createElement('div');
                newCalculator.innerHTML = calculatorHTML;
                container.appendChild(newCalculator.firstElementChild);
                
                setupCalculatorEvents(calculatorId);
            }
            
            function setupCalculatorEvents(calculatorId) {
                const inputField = document.getElementById('inputField' + calculatorId);
                const outputField = document.getElementById('outputField' + calculatorId);
                const resultField = document.getElementById('resultField' + calculatorId);
                
                if (inputField && outputField && resultField) {
                    inputField.addEventListener('input', function() {
                        evaluateExpression(inputField.value, outputField, resultField);
                    });
                    
                    resultField.addEventListener('input', function() {
                        updateVariables();
                        evaluateAllCalculators();
                    });
                }
                
                // Add save button listeners
                const calculatorElement = document.getElementById('calculator_' + calculatorId);
                if (calculatorElement) {
                    calculatorElement.addEventListener('click', function(e) {
                        if (e.target.classList.contains('save-btn') || e.target.classList.contains('save-expr-btn')) {
                            const fieldId = e.target.getAttribute('data-field');
                            if (fieldId) saveInput(fieldId);
                        }
                    });
                }
            }
            
            // Event delegation for save buttons
            function setupAllEventListeners() {
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('save-btn') || 
                        e.target.classList.contains('save-expr-btn') || 
                        e.target.classList.contains('compact-save-btn')) {
                        const fieldId = e.target.getAttribute('data-field');
                        if (fieldId) saveInput(fieldId);
                    }
                });
                
                // Setup calculators 1 and 2
                setupCalculatorEvents(1);
                setupCalculatorEvents(2);
                
                // Setup variable event listeners
                for (let i = 1; i <= 10; i++) {
                    const valueField = document.getElementById('variableValue' + i);
                    const nameField = document.getElementById('variableName' + i);
                    if (valueField) {
                        valueField.addEventListener('input', evaluateAllCalculators);
                    }
                    if (nameField) {
                        nameField.addEventListener('input', evaluateAllCalculators);
                    }
                }
                
                // Add calculator button
                const addBtn = document.getElementById('addCalculatorBtn');
                if (addBtn) {
                    addBtn.addEventListener('click', function() {
                        calculatorCount++;
                        createCalculator(calculatorCount);
                    });
                }
            }
            
            // Mathematical functions
            ${updateVariables.toString()}
            ${replaceVariables.toString()}
            ${factorial.toString()}
            ${toRadians.toString()}
            ${toDegrees.toString()}
            ${replaceLogSyntax.toString()}
            ${replaceTrigFunctions.toString()}
            ${replaceInverseTrigFunctions.toString()}
            ${replaceFactorialSyntax.toString()}
            ${evaluateExpression.toString()}
            ${evaluateAllCalculators.toString()}
            
            // Unit converter functions
            ${showUnitConverter.toString()}
            ${closeUnitConverter.toString()}
            ${convertLength.toString()}
            ${convertWeight.toString()}
            ${convertVolume.toString()}
            ${convertTemperature.toString()}
            `;
        }
        
        // ============================================
        // 3. MATHEMATICAL ENGINE (UNCHANGED)
        // ============================================
        
        function updateVariables() {
            variables = {};
            
            // Get variable values
            for (let i = 1; i <= 10; i++) {
                const nameField = document.getElementById('variableName' + i);
                const valueField = document.getElementById('variableValue' + i);
                if (nameField && valueField) {
                    const name = nameField.value.trim();
                    const value = parseFloat(valueField.value.trim());
                    if (name && !isNaN(value)) {
                        variables[name] = value;
                    }
                }
            }
            
            // Get calculator results as variables
            for (let i = 1; i <= calculatorCount; i++) {
                const resultField = document.getElementById('resultField' + i);
                const outputField = document.getElementById('outputField' + i);
                if (resultField && outputField) {
                    const resultName = resultField.value.trim();
                    const resultValue = parseFloat(outputField.textContent);
                    if (resultName && !isNaN(resultValue)) {
                        variables[resultName] = resultValue;
                    }
                }
            }
        }
        
        function replaceVariables(expression) {
            expression = expression.replace(/\\bpi\\b/g, Math.PI);
            expression = expression.replace(/\\bg\\b/g, 9.8);
            
            for (const [name, value] of Object.entries(variables)) {
                const regex = new RegExp(\`\\\\b\${name}\\\\b\`, 'g');
                expression = expression.replace(regex, value);
            }
            return expression;
        }
        
        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }
        
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }
        
        function toDegrees(radians) {
            return radians * (180 / Math.PI);
        }
        
        function replaceLogSyntax(expression) {
            const logRegex = /log(\\d+|e)\\(([^)]+)\\)/g;
            return expression.replace(logRegex, (match, base, y) => {
                if (base === 'e') return \`Math.log(\${y})\`;
                else return \`(Math.log(\${y}) / Math.log(\${base}))\`;
            });
        }
        
        function replaceTrigFunctions(expression) {
            expression = expression.replace(/sin\\(([^)]+)\\)/g, (match, x) => {
                return \`Math.sin(toRadians(\${x}))\`;
            });
            expression = expression.replace(/cos\\(([^)]+)\\)/g, (match, x) => {
                return \`Math.cos(toRadians(\${x}))\`;
            });
            expression = expression.replace(/tan\\(([^)]+)\\)/g, (match, x) => {
                return \`Math.tan(toRadians(\${x}))\`;
            });
            return expression;
        }
        
        function replaceInverseTrigFunctions(expression) {
            expression = expression.replace(/sin-1\\(([^)]+)\\)/g, (match, x) => {
                return \`toDegrees(Math.asin(\${x}))\`;
            });
            expression = expression.replace(/cos-1\\(([^)]+)\\)/g, (match, x) => {
                return \`toDegrees(Math.acos(\${x}))\`;
            });
            expression = expression.replace(/tan-1\\(([^)]+)\\)/g, (match, x) => {
                return \`toDegrees(Math.atan(\${x}))\`;
            });
            return expression;
        }
        
        function replaceFactorialSyntax(expression) {
            const factorialRegex = /(\\d+)!/g;
            return expression.replace(factorialRegex, (match, x) => {
                return \`factorial(\${x})\`;
            });
        }
        
        function evaluateExpression(expression, outputField, resultField) {
            try {
                updateVariables();
                expression = replaceVariables(expression);
                expression = expression.replace(/\\^/g, '**');
                expression = expression.replace(/\\be\\b/g, Math.E);
                expression = replaceLogSyntax(expression);
                expression = replaceTrigFunctions(expression);
                expression = replaceInverseTrigFunctions(expression);
                expression = replaceFactorialSyntax(expression);
                const result = eval(expression);
                outputField.textContent = result;
                updateVariables();
            } catch (error) {
                outputField.textContent = 'Error';
            }
        }
        
        function evaluateAllCalculators() {
            for (let i = 1; i <= calculatorCount; i++) {
                const inputField = document.getElementById('inputField' + i);
                const outputField = document.getElementById('outputField' + i);
                const resultField = document.getElementById('resultField' + i);
                if (inputField && outputField && resultField) {
                    evaluateExpression(inputField.value, outputField, resultField);
                }
            }
        }
        
        // ============================================
        // 4. UNIT CONVERTER FUNCTIONS
        // ============================================
        
        function showUnitConverter() {
            document.getElementById('unitConverterModal').style.display = 'block';
        }
        
        function closeUnitConverter() {
            document.getElementById('unitConverterModal').style.display = 'none';
        }
        
        // Simple conversion functions (kept brief)
        function convertLength() {
            const value = parseFloat(document.getElementById('length-value').value);
            const fromUnit = document.getElementById('length-from').value;
            const toUnit = document.getElementById('length-to').value;
            const factors = { mm: 0.001, cm: 0.01, m: 1, km: 1000 };
            if (!isNaN(value)) {
                const meters = value * factors[fromUnit];
                const result = meters / factors[toUnit];
                document.getElementById('length-result').textContent = result.toFixed(6);
            }
        }
        
        function convertWeight() {
            const value = parseFloat(document.getElementById('weight-value').value);
            const fromUnit = document.getElementById('weight-from').value;
            const toUnit = document.getElementById('weight-to').value;
            const factors = { g: 0.001, kg: 1, oz: 0.0283495, lb: 0.453592 };
            if (!isNaN(value)) {
                const kg = value * factors[fromUnit];
                const result = kg / factors[toUnit];
                document.getElementById('weight-result').textContent = result.toFixed(6);
            }
        }
        
        function convertVolume() {
            const value = parseFloat(document.getElementById('volume-value').value);
            const fromUnit = document.getElementById('volume-from').value;
            const toUnit = document.getElementById('volume-to').value;
            const factors = { ml: 0.001, l: 1, gal: 3.78541 };
            if (!isNaN(value)) {
                const liters = value * factors[fromUnit];
                const result = liters / factors[toUnit];
                document.getElementById('volume-result').textContent = result.toFixed(6);
            }
        }
        
        function convertTemperature() {
            const value = parseFloat(document.getElementById('temp-value').value);
            const fromUnit = document.getElementById('temp-from').value;
            const toUnit = document.getElementById('temp-to').value;
            if (isNaN(value)) return;
            
            let celsius;
            switch(fromUnit) {
                case 'c': celsius = value; break;
                case 'f': celsius = (value - 32) * 5/9; break;
                case 'k': celsius = value - 273.15; break;
            }
            
            let result;
            switch(toUnit) {
                case 'c': result = celsius; break;
                case 'f': result = celsius * 9/5 + 32; break;
                case 'k': result = celsius + 273.15; break;
            }
            
            document.getElementById('temp-result').textContent = result.toFixed(6);
        }
        
        // ============================================
        // 5. INITIALIZATION
        // ============================================
        
        // Setup event listeners for save buttons (event delegation)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('save-btn') || 
                e.target.classList.contains('save-expr-btn') || 
                e.target.classList.contains('compact-save-btn')) {
                const fieldId = e.target.getAttribute('data-field');
                if (fieldId) {
                    saveInput(fieldId);
                }
            }
        });
        
        // Setup calculators 1 and 2
        setupCalculatorEvents(1);
        setupCalculatorEvents(2);
        
        // Setup variable event listeners
        for (let i = 1; i <= 10; i++) {
            const valueField = document.getElementById('variableValue' + i);
            const nameField = document.getElementById('variableName' + i);
            if (valueField) {
                valueField.addEventListener('input', evaluateAllCalculators);
            }
            if (nameField) {
                nameField.addEventListener('input', evaluateAllCalculators);
            }
        }
        
        // PWA Installation
        let deferredPrompt;
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById("installApp").style.display = "block";
            document.getElementById("installApp").addEventListener("click", () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === "accepted") console.log("App Installed");
                    deferredPrompt = null;
                });
            });
        });
        
        // Service Worker
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js").then(() => {
                console.log("Service Worker Registered!");
            });
        }
        
        // Initial calculation
        setTimeout(function() {
            updateVariables();
            evaluateAllCalculators();
        }, 100);
    </script>
</body>
</html>
